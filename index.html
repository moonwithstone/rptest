<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FRI 计算工具</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#1f2329;
      --sub:#646a73;
      --line:#e6e8ee;
      --blue:#1677ff;
      --blue2:#eaf2ff;
      --grayBtn:#d0d5dd;
      --shadow:0 8px 24px rgba(31,35,41,.08);
      --radius:12px;

      --green:#17c964;
      --yellow:#f5a524;
      --red:#f31260;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Alibaba PuHuiTi 2.0","Alibaba PuHuiTi","Microsoft YaHei",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:var(--bg);
    }
    a{color:inherit;text-decoration:none}

    /* Header (53px) */
    .topbar{
      height:53px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 20px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#ffffff,#fbfcff);
      position:sticky;
      top:0;
      z-index:5;
    }
    .title{min-width:0;
      line-height:1;
    
      font-size:16px;      /* 页面标题16px不加粗 */
      font-weight:400;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .crumb{
      font-size:14px;color:var(--sub);margin-left:6px;
    }
    .top-actions{display:flex;gap:12px;align-items:center}

    /* Buttons */
    .btn{
      height:32px;
      padding:0 12px;
      border-radius:10px;
      border:1px solid transparent;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      font-size:14px;
      background:#fff;
    }
    .btn svg{width:16px;height:16px}
    .btn-primary{
      background:var(--blue);
      border-color:var(--blue);
      color:#fff;
      box-shadow:0 6px 16px rgba(22,119,255,.22);
    }
    .btn-secondary{
      background:#fff;
      border-color:var(--blue);
      color:var(--blue);
    }
    .btn-low{
      background:#fff;
      border-color:var(--grayBtn);
      color:var(--text);
    }
    .btn-disabled{
      opacity:.4;
      cursor:not-allowed;
      pointer-events:none;
    }

    .wrap{
      padding:16px 20px 20px;
      display:grid;
      gap:16px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(230,232,238,.8);
      overflow:hidden;
    }
    .card-hd{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .card-hd .hd-title{
      font-size:14px;
      font-weight:600;
      display:flex;align-items:center;gap:10px;
    }

    /* Tabs (控制整个功能页面切换) */
    .tabs{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .tab{
      height:32px; /* 规范：Tab高度32 */
      padding:0 12px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--sub);
      display:flex;align-items:center;gap:8px;
      cursor:pointer;
      font-size:14px;
    }
    .tab.active{
      color:var(--blue);
      background:var(--blue2);
      border-color:rgba(22,119,255,.35);
      font-weight:600;
    }

    /* Query form (1行4列，间距12px) */
    .form{
      padding:12px;
    }
    .grid4{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      align-items:end;
    }
    @media (max-width: 1100px){
      .grid4{grid-template-columns: repeat(2, 1fr);}
    }
    @media (max-width: 720px){
      .grid4{grid-template-columns: 1fr;}
    }
    .field{min-width:0}
    .label{
      font-size:14px;
      color:var(--sub);
      margin-bottom:8px;
      display:flex;align-items:center;gap:6px;
    }
    .input, .select{
      width:100%;
      height:36px;
      border:1px solid var(--line);
      border-radius:10px;
      padding:0 10px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .form-actions{
      display:flex;
      justify-content:flex-end;
      gap:12px;
      padding:12px 12px 0;
    }

    /* Collapsible extra filters */
    .more{
      margin-top:10px;
      border-top:1px dashed rgba(230,232,238,.9);
      padding-top:12px;
      display:none;
    }
    .toggle-more{
      color:var(--blue);
      cursor:pointer;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    /* Table (单业务：无竖线) */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:14px;
    }
    thead th{
      text-align:left;
      color:var(--sub);
      font-weight:600;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      background:#fff;
      position:sticky;top:0;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      background:#fff;
      vertical-align:middle;
    }
    tbody tr:hover td{background:#fbfcff}
    .align-center{text-align:center}
    .align-right{text-align:right}
    .ellipsis{
      max-width:220px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .badge{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--sub);
      background:#fff;
      white-space:nowrap;
      display:inline-flex;align-items:center;gap:8px;
    }
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .empty{
      padding:36px 12px;
      text-align:center;
      color:var(--sub);
      font-size:14px;
    }

    /* Drawer (有具体操作且内容多：抽屉) */
    .drawer-mask{
      position:fixed;inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      z-index:60;
    }
    .drawer{
      position:fixed;
      top:0; right:-520px;
      width:min(520px, 92vw);
      height:100vh;
      background:#fff;
      border-left:1px solid var(--line);
      box-shadow:-16px 0 40px rgba(31,35,41,.18);
      transition:right .2s ease;
      z-index:61;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{right:0}
    .drawer-hd{
      height:53px;
      padding:0 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:linear-gradient(180deg,#ffffff,#fbfcff);
    }
    .drawer-title{
      font-size:16px;
      font-weight:600;
      display:flex;align-items:center;gap:10px;
    }
    .drawer-bd{
      padding:16px;
      overflow:auto;
    }
    .drawer-ft{
      padding:14px 16px;
      border-top:1px solid var(--line);
      display:flex;justify-content:flex-end;gap:12px;
      background:#fff;
    }

    /* Modal (导出选择：弹窗) */
    .mask{
      position:fixed;inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:70;
    }
    .modal{
      width:min(920px, 100%);
      max-height:min(800px, 90vh);
      overflow:auto;
      border-radius:16px;
      background:linear-gradient(180deg,#EAF0FF,#FFFFFF);
      border:1px solid rgba(230,232,238,.9);
      box-shadow:0 18px 50px rgba(31,35,41,.22);
    }
    .modal-hd{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .modal-title{
      font-size:16px;
      font-weight:600;
      display:flex;align-items:center;gap:10px;
    }
    .modal-bd{padding:16px}
    .modal-ft{
      padding:14px 16px;
      border-top:1px solid var(--line);
      display:flex;justify-content:flex-end;gap:12px;
      background:rgba(255,255,255,.75);
      backdrop-filter: blur(8px);
      position:sticky;bottom:0;
    }

    .checklist{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .check-item{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }
    .check-item .meta{
      font-size:12px;color:var(--sub);margin-top:4px;
    }

    .loading{
      display:inline-flex;align-items:center;gap:8px;color:var(--sub);font-size:14px;
    }
    .spinner{
      width:16px;height:16px;border-radius:999px;
      border:2px solid rgba(22,119,255,.22);
      border-top-color:var(--blue);
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  
    .title-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px;display:inline-block;}
    .subheader{
      padding:12px 20px 0;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .sub-left{min-width:0}
    .sub-breadcrumb{font-size:12px;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px;}
    .sub-title{font-size:14px;font-weight:600;color:var(--text);line-height:20px;}
    .sub-desc{font-size:12px;color:var(--sub);line-height:18px;margin-top:4px;max-width:920px;}
    @media (max-width: 900px){
      .title-text{max-width:260px}
      .subheader{flex-direction:column;align-items:flex-start}
      .sub-breadcrumb{max-width:100%}
    }
    
  </style>
</head>
<body>

<div class="topbar">
  <div class="title">
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M4 19V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v14" stroke="#1677ff" stroke-width="2" stroke-linecap="round"/>
      <path d="M7 9h10M7 13h6" stroke="#1677ff" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class=\"title-text\">FRI 计算工具</span>
  </div>

  <div class="top-actions">
    <a class="btn btn-secondary" href="fri_analysis.html" title="返回FRI分析页面">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      返回FRI分析
    </a>
    <button class="btn btn-low" id="btnMock">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M20 12a8 8 0 1 1-2.34-5.66" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M20 4v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      生成模拟记录
    </button>
  </div>
</div>
<div class="subheader">
  <div class="sub-left">
    <div class="sub-breadcrumb">风险指标 / FRI / 计算工具（子页面）</div>
    <div class="sub-title">定时计算 · 手动计算 · 计算数据列表 · 多模板导出</div>
    <div class="sub-desc">计算支持两种方式：①定时计算（可配置定时任务）；②手动计算（按钮触发）。计算记录默认展示15条，支持勾选后按模板/渠道导出用于多渠道汇报。</div>
  </div>
</div>


<div class="wrap">
  <!-- Top Card: Tabs + actions -->
  <div class="card">
    <div class="card-hd">
      <div class="hd-title">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 6h16M7 12h10M10 18h4" stroke="#1677ff" stroke-width="2" stroke-linecap="round"/>
        </svg>
        计算方式
      </div>
      <div class="tabs" role="tablist" aria-label="计算方式">
        <div class="tab active" id="tabTimer">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 8v5l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 22a9 9 0 1 0-9-9 9 9 0 0 0 9 9Z" stroke="currentColor" stroke-width="2"/></svg>
          定时计算
        </div>
        <div class="tab" id="tabManual">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v18M3 12h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          手动计算
        </div>
      </div>
    </div>

    <!-- Timer panel -->
    <div class="form" id="panelTimer">
      <div class="grid4">
        <div class="field">
          <div class="label">任务名称</div>
          <input class="input" id="timerName" placeholder="例：每日02:00-全基地计算" value="每日02:00-全基地计算"/>
        </div>
        <div class="field">
          <div class="label">计划表达式（Cron）</div>
          <input class="input" id="timerCron" placeholder="例：0 0 2 * * *" value="0 0 2 * * *"/>
        </div>
        <div class="field">
          <div class="label">范围（基地）</div>
          <select class="select" id="timerBase">
            <option value="ALL">全部基地</option>
            <option value="B1">基地-01（东区）</option>
            <option value="B2">基地-02（西区）</option>
            <option value="B3">基地-03（南区）</option>
            <option value="B4">基地-04（北区）</option>
            <option value="B5">基地-05（海岛）</option>
            <option value="B6">基地-06（内陆）</option>
          </select>
        </div>
        <div class="field">
          <div class="label">任务状态</div>
          <select class="select" id="timerState">
            <option value="ENABLED">启用</option>
            <option value="DISABLED">停用</option>
          </select>
        </div>
      </div>

      <div class="form-actions">
        <div class="toggle-more" id="btnMore">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 15l-6-6h12l-6 6Z" stroke="#1677ff" stroke-width="2" stroke-linejoin="round"/></svg>
          更多配置
        </div>
        <button class="btn btn-secondary" id="btnOpenDrawer">
          <svg viewBox="0 0 24 24" fill="none"><path d="M4 4h16v16H4z" stroke="currentColor" stroke-width="2"/><path d="M8 8h8M8 12h8M8 16h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          配置定时任务
        </button>
        <button class="btn btn-primary" id="btnRunTimer">
          <svg viewBox="0 0 24 24" fill="none"><path d="M8 5v14l11-7-11-7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
          立即执行一次
        </button>
      </div>

      <div class="more" id="moreArea">
        <div class="grid4">
          <div class="field">
            <div class="label">数据窗口（小时）</div>
            <input class="input" id="timerWindow" value="24" />
          </div>
          <div class="field">
            <div class="label">是否引入偏离因子</div>
            <select class="select" id="timerBias">
              <option value="AUTO">自动（按数据源）</option>
              <option value="ON">是</option>
              <option value="OFF">否</option>
            </select>
          </div>
          <div class="field">
            <div class="label">告警限值版本</div>
            <select class="select" id="timerLimitVer">
              <option value="V1">V1（默认：0.037/0.45）</option>
              <option value="V0">V0（旧资料）</option>
            </select>
          </div>
          <div class="field">
            <div class="label">备注</div>
            <input class="input" id="timerRemark" placeholder="可选：描述数据源/计算口径等"/>
          </div>
        </div>
      </div>
    </div>

    <!-- Manual panel -->
    <div class="form" id="panelManual" style="display:none;">
      <div class="grid4">
        <div class="field">
          <div class="label">基地</div>
          <select class="select" id="mBase">
            <option value="B1">基地-01（东区）</option>
            <option value="B2">基地-02（西区）</option>
            <option value="B3">基地-03（南区）</option>
            <option value="B4">基地-04（北区）</option>
            <option value="B5">基地-05（海岛）</option>
            <option value="B6">基地-06（内陆）</option>
          </select>
        </div>
        <div class="field">
          <div class="label">机组</div>
          <select class="select" id="mUnit">
            <option>1#机组</option><option>2#机组</option><option>3#机组</option><option>4#机组</option>
          </select>
        </div>
        <div class="field">
          <div class="label">开始时间</div>
          <input class="input" id="mStart" type="datetime-local"/>
        </div>
        <div class="field">
          <div class="label">结束时间</div>
          <input class="input" id="mEnd" type="datetime-local"/>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-low" id="btnFillNow">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 22a9 9 0 1 0-9-9 9 9 0 0 0 9 9Z" stroke="currentColor" stroke-width="2"/><path d="M12 7v5l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          快速填充24小时
        </button>
        <button class="btn btn-secondary" id="btnManualOptions">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v18M3 12h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          参数选项
        </button>
        <button class="btn btn-primary" id="btnRunManual">
          <svg viewBox="0 0 24 24" fill="none"><path d="M8 5v14l11-7-11-7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
          手动计算
        </button>
      </div>
      <div style="margin-top:10px;color:var(--sub);font-size:12px;">
        注：原型页模拟“计算队列→完成”的过程，实际项目可对接你xlsx的输入数据列表与计算引擎。
      </div>
    </div>
  </div>

  <!-- Data list -->
  <div class="card">
    <div class="card-hd">
      <div class="hd-title">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 7h12M6 12h12M6 17h12" stroke="#1677ff" stroke-width="2" stroke-linecap="round"/>
        </svg>
        计算数据列表（默认展示15条）
      </div>
      <div style="display:flex;gap:12px;align-items:center;">
        <button class="btn btn-low btn-disabled" id="btnDelete">
          <svg viewBox="0 0 24 24" fill="none"><path d="M6 7h12M9 7V5h6v2M8 7l1 14h6l1-14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          删除
        </button>
        <button class="btn btn-low btn-disabled" id="btnExport">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v12M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 21h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          导出
        </button>
      </div>
    </div>

    <div style="padding:12px;">
      <div style="border:1px solid var(--line);border-radius:14px;overflow:hidden;max-height:520px;overflow:auto;">
        <table>
          <thead>
            <tr>
              <th class="align-center" style="width:54px;">
                <input type="checkbox" id="chkAll" />
              </th>
              <th style="width:160px;">批次ID</th>
              <th style="width:160px;">基地</th>
              <th class="align-center" style="width:110px;">机组</th>
              <th style="width:210px;">时间范围</th>
              <th class="align-center" style="width:140px;">数据完整度</th>
              <th class="align-center" style="width:120px;">偏离因子</th>
              <th class="align-right" style="width:120px;">FRI结果</th>
              <th class="align-center" style="width:120px;">状态</th>
              <th style="width:180px;">生成时间</th>
              <th class="align-center" style="width:120px;">操作</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="11"><div class="empty">暂无数据</div></td></tr>
          </tbody>
        </table>
      </div>
      <div style="margin-top:10px;color:var(--sub);font-size:12px;">
        列表字段对齐遵循规范：金额/数值右对齐，固定长度字段居中，其他左对齐；空值以“-”显示。
      </div>
    </div>
  </div>
</div>

<!-- Drawer for timer config -->
<div class="drawer-mask" id="drawerMask"></div>
<div class="drawer" id="drawer">
  <div class="drawer-hd">
    <div class="drawer-title">
      <svg viewBox="0 0 24 24" fill="none"><path d="M4 4h16v16H4z" stroke="#1677ff" stroke-width="2"/><path d="M8 8h8M8 12h8M8 16h6" stroke="#1677ff" stroke-width="2" stroke-linecap="round"/></svg>
      定时任务配置
    </div>
    <button class="btn btn-low" id="btnDrawerClose">
      <svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6l-12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      关闭
    </button>
  </div>
  <div class="drawer-bd">
    <div class="grid4" style="grid-template-columns:repeat(2,1fr);">
      <div class="field">
        <div class="label">任务名称</div>
        <input class="input" id="dName" placeholder="例：每日02:00-全基地计算"/>
      </div>
      <div class="field">
        <div class="label">Cron表达式</div>
        <input class="input" id="dCron" placeholder="0 0 2 * * *"/>
      </div>
      <div class="field">
        <div class="label">基地范围</div>
        <select class="select" id="dBase">
          <option value="ALL">全部基地</option>
          <option value="B1">基地-01（东区）</option>
          <option value="B2">基地-02（西区）</option>
          <option value="B3">基地-03（南区）</option>
          <option value="B4">基地-04（北区）</option>
          <option value="B5">基地-05（海岛）</option>
          <option value="B6">基地-06（内陆）</option>
        </select>
      </div>
      <div class="field">
        <div class="label">是否启用</div>
        <select class="select" id="dEnabled">
          <option value="true">启用</option>
          <option value="false">停用</option>
        </select>
      </div>
      <div class="field">
        <div class="label">数据窗口（小时）</div>
        <input class="input" id="dWindow" value="24"/>
      </div>
      <div class="field">
        <div class="label">偏离因子策略</div>
        <select class="select" id="dBias">
          <option value="AUTO">自动</option>
          <option value="ON">强制启用</option>
          <option value="OFF">强制关闭</option>
        </select>
      </div>
      <div class="field" style="grid-column:1/-1;">
        <div class="label">说明</div>
        <input class="input" id="dDesc" placeholder="例：数据源、口径说明、异常处理策略等"/>
      </div>
    </div>

    <div style="margin-top:12px;padding:10px;border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,#EAF0FF,#FFFFFF);font-size:14px;color:var(--sub);">
      抽屉用于“有具体操作且信息较多”的配置场景（符合规范）。保存后任务会出现在列表中（本原型以模拟记录展示）。
    </div>
  </div>
  <div class="drawer-ft">
    <button class="btn btn-low" id="btnDrawerCancel">取消</button>
    <button class="btn btn-primary" id="btnDrawerSave">确认</button>
  </div>
</div>

<!-- Export modal -->
<div class="mask" id="mask">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="modal-hd">
      <div class="modal-title" id="mTitle">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v12M7 10l5 5 5-5" stroke="#1677ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 21h14" stroke="#1677ff" stroke-width="2" stroke-linecap="round"/></svg>
        导出设置（选择模板/渠道）
      </div>
      <button class="btn btn-low" id="btnClose">
        <svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6l-12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        关闭
      </button>
    </div>
    <div class="modal-bd">
      <div style="font-size:14px;color:var(--sub);">
        已选中 <b id="selCount">0</b> 条记录。请选择导出模板（支持多渠道汇报）。
      </div>

      <div class="checklist" id="tplList"></div>

      <div style="margin-top:16px;">
        <div style="font-size:14px;font-weight:600;margin-bottom:10px;">导出渠道</div>
        <div class="check-item">
          <input type="checkbox" id="ch1" checked />
          <div>
            <div>管理平台报表中心</div>
            <div class="meta">用于平台内归档与查询（示例渠道）</div>
          </div>
        </div>
        <div class="check-item">
          <input type="checkbox" id="ch2" />
          <div>
            <div>邮件/附件分发</div>
            <div class="meta">用于对外发送（示例渠道）</div>
          </div>
        </div>
        <div class="check-item">
          <input type="checkbox" id="ch3" />
          <div>
            <div>即时通讯群推送</div>
            <div class="meta">用于快速通报（示例渠道）</div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-low" id="btnCancel">取消</button>
      <button class="btn btn-primary" id="btnDoExport">确认</button>
    </div>
  </div>
</div>

<script>
  const TH_GREEN = 0.037;
  const TH_RED = 0.45;

  const bases = {
    B1:"基地-01（东区）", B2:"基地-02（西区）", B3:"基地-03（南区）",
    B4:"基地-04（北区）", B5:"基地-05（海岛）", B6:"基地-06（内陆）"
  };

  function statusOf(fri){
    if (fri <= TH_GREEN) return { key:"green", text:"正常", color:"var(--green)" };
    if (fri >= TH_RED) return { key:"red", text:"告警", color:"var(--red)" };
    return { key:"yellow", text:"预警", color:"var(--yellow)" };
  }

  function randFri(){
    const r = Math.random();
    if (r < 0.78) return +(Math.random() * 0.035).toFixed(4);
    if (r < 0.94) return +(0.038 + Math.random() * 0.38).toFixed(4);
    return +(0.45 + Math.random() * 0.2).toFixed(4);
  }

  let records = [];   // {id, baseId, unit, range, completeness, bias, fri, status, created, type}
  let selected = new Set();

  const tbody = document.getElementById("tbody");
  const btnExport = document.getElementById("btnExport");
  const btnDelete = document.getElementById("btnDelete");
  const chkAll = document.getElementById("chkAll");

  function nowStr(){
    return new Date().toLocaleString();
  }
  function fmtRange(s,e){
    return `${s} ~ ${e}`;
  }
  function makeId(prefix){
    const r = Math.random().toString(16).slice(2,8).toUpperCase();
    const t = Date.now().toString().slice(-6);
    return `${prefix}-${t}-${r}`;
  }

  function renderTable(){
    const rows = records.slice(0, 15);
    if (!rows.length){
      tbody.innerHTML = `<tr><td colspan="11"><div class="empty">暂无数据</div></td></tr>`;
      btnExport.classList.add("btn-disabled");
      btnDelete.classList.add("btn-disabled");
      return;
    }

    tbody.innerHTML = rows.map(r=>{
      const checked = selected.has(r.id) ? "checked" : "";
      const st = r.status;
      return `
        <tr>
          <td class="align-center"><input type="checkbox" class="chkRow" data-id="${r.id}" ${checked}></td>
          <td class="ellipsis" title="${r.id}">${r.id}</td>
          <td class="ellipsis" title="${bases[r.baseId]}">${bases[r.baseId]}</td>
          <td class="align-center">${r.unit}</td>
          <td class="ellipsis" title="${r.range}">${r.range}</td>
          <td class="align-center">${r.completeness ?? "-"}</td>
          <td class="align-center">${r.bias ?? "-"}</td>
          <td class="align-right"><b>${r.fri ?? "-"}</b></td>
          <td class="align-center">
            <span class="badge">
              <span class="dot" style="background:${st?.color ?? 'rgba(0,0,0,.18)'}"></span>
              ${st?.text ?? "处理中"}
            </span>
          </td>
          <td>${r.created}</td>
          <td class="align-center">
            <button class="btn btn-secondary" style="height:28px" data-view="${r.id}">查看</button>
          </td>
        </tr>
      `;
    }).join("");

    // selection buttons
    const hasSel = selected.size > 0;
    btnExport.classList.toggle("btn-disabled", !hasSel);
    btnDelete.classList.toggle("btn-disabled", !hasSel);

    // bind row checkbox
    document.querySelectorAll(".chkRow").forEach(chk=>{
      chk.addEventListener("change", (e)=>{
        const id = e.target.getAttribute("data-id");
        if (e.target.checked) selected.add(id); else selected.delete(id);
        syncHeaderCheckbox();
        renderTable();
      });
    });

    // bind view
    document.querySelectorAll("button[data-view]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-view");
        alert("原型提示：这里可打开详情页/抽屉，展示输入数据明细、缺失字段、偏离因子来源等。\n\n批次ID：" + id);
      });
    });

    syncHeaderCheckbox();
  }

  function syncHeaderCheckbox(){
    const rows = records.slice(0, 15).map(r=>r.id);
    const selCount = rows.filter(id=>selected.has(id)).length;
    chkAll.indeterminate = selCount > 0 && selCount < rows.length;
    chkAll.checked = rows.length>0 && selCount === rows.length;
  }

  chkAll.addEventListener("change", (e)=>{
    const rows = records.slice(0, 15).map(r=>r.id);
    if (e.target.checked) rows.forEach(id=>selected.add(id));
    else rows.forEach(id=>selected.delete(id));
    renderTable();
  });

  // Tabs
  const tabTimer = document.getElementById("tabTimer");
  const tabManual = document.getElementById("tabManual");
  const panelTimer = document.getElementById("panelTimer");
  const panelManual = document.getElementById("panelManual");

  tabTimer.addEventListener("click", ()=>{
    tabTimer.classList.add("active");
    tabManual.classList.remove("active");
    panelTimer.style.display = "";
    panelManual.style.display = "none";
  });
  tabManual.addEventListener("click", ()=>{
    tabManual.classList.add("active");
    tabTimer.classList.remove("active");
    panelManual.style.display = "";
    panelTimer.style.display = "none";
  });

  // More
  const btnMore = document.getElementById("btnMore");
  const moreArea = document.getElementById("moreArea");
  btnMore.addEventListener("click", ()=>{
    moreArea.style.display = (moreArea.style.display==="none" || !moreArea.style.display) ? "block" : "none";
  });

  // Drawer open/close
  const drawer = document.getElementById("drawer");
  const drawerMask = document.getElementById("drawerMask");
  const btnOpenDrawer = document.getElementById("btnOpenDrawer");
  const btnDrawerClose = document.getElementById("btnDrawerClose");
  const btnDrawerCancel = document.getElementById("btnDrawerCancel");
  const btnDrawerSave = document.getElementById("btnDrawerSave");

  function openDrawer(){
    drawerMask.style.display = "block";
    drawer.classList.add("open");
    // preload from top form
    document.getElementById("dName").value = document.getElementById("timerName").value;
    document.getElementById("dCron").value = document.getElementById("timerCron").value;
    document.getElementById("dBase").value = document.getElementById("timerBase").value;
    document.getElementById("dEnabled").value = (document.getElementById("timerState").value==="ENABLED") ? "true" : "false";
  }
  function closeDrawer(){
    drawerMask.style.display = "none";
    drawer.classList.remove("open");
  }
  btnOpenDrawer.addEventListener("click", openDrawer);
  btnDrawerClose.addEventListener("click", closeDrawer);
  btnDrawerCancel.addEventListener("click", closeDrawer);
  drawerMask.addEventListener("click", closeDrawer);

  btnDrawerSave.addEventListener("click", ()=>{
    // sync back to top form
    document.getElementById("timerName").value = document.getElementById("dName").value;
    document.getElementById("timerCron").value = document.getElementById("dCron").value;
    document.getElementById("timerBase").value = document.getElementById("dBase").value;
    document.getElementById("timerState").value = (document.getElementById("dEnabled").value==="true") ? "ENABLED" : "DISABLED";
    closeDrawer();
    alert("已保存（原型提示）：实际项目中可落库，并由调度器创建/更新定时任务。");
  });

  // Manual quick fill
  const mStart = document.getElementById("mStart");
  const mEnd = document.getElementById("mEnd");
  document.getElementById("btnFillNow").addEventListener("click", ()=>{
    const end = new Date();
    const start = new Date(end.getTime() - 24*3600*1000);
    mEnd.value = end.toISOString().slice(0,16);
    mStart.value = start.toISOString().slice(0,16);
  });

  document.getElementById("btnManualOptions").addEventListener("click", ()=>{
    alert("原型提示：这里可做参数面板（如数据源选择、缺失字段处理策略、偏离因子口径、阈值版本等）。");
  });

  // Run timer once
  document.getElementById("btnRunTimer").addEventListener("click", ()=>{
    const baseId = document.getElementById("timerBase").value;
    const scope = baseId==="ALL" ? Object.keys(bases) : [baseId];
    const units = ["1#机组","2#机组","3#机组","4#机组"];

    scope.forEach(b=>{
      units.forEach(u=>{
        enqueueRecord("TIMER", b, u, 24);
      });
    });
    renderTable();
  });

  // Run manual
  document.getElementById("btnRunManual").addEventListener("click", ()=>{
    const baseId = document.getElementById("mBase").value;
    const unit = document.getElementById("mUnit").value;
    const s = mStart.value, e = mEnd.value;

    if (!s || !e){
      alert("请先选择开始时间与结束时间。");
      return;
    }

    const hours = Math.max(1, Math.round((new Date(e)-new Date(s))/3600000));
    enqueueRecord("MANUAL", baseId, unit, hours, s, e);
    renderTable();
  });

  function enqueueRecord(type, baseId, unit, hours, s, e){
    const id = makeId(type);
    const end = e ? new Date(e) : new Date();
    const start = s ? new Date(s) : new Date(end.getTime() - hours*3600*1000);

    const rec = {
      id,
      baseId,
      unit,
      range: fmtRange(start.toLocaleString(), end.toLocaleString()),
      completeness: "-",
      bias: "-",
      fri: "-",
      status: null,
      created: nowStr(),
      type
    };
    records.unshift(rec);

    // simulate queue -> finish
    const delay = 600 + Math.random()*1200;
    setTimeout(()=>{
      // completeness and bias mock
      const comp = (92 + Math.random()*8).toFixed(1) + "%";
      const biasOn = Math.random() < 0.35; // some records uses bias factor
      const bias = biasOn ? (0.85 + Math.random()*0.3).toFixed(2) : "未引入";
      const fri = randFri();
      rec.completeness = comp;
      rec.bias = bias;
      rec.fri = fri;
      rec.status = statusOf(fri);
      renderTable();
    }, delay);
  }

  // Delete
  btnDelete.addEventListener("click", ()=>{
    if (btnDelete.classList.contains("btn-disabled")) return;
    if (!confirm("确认删除选中记录？")) return;
    records = records.filter(r=>!selected.has(r.id));
    selected.clear();
    renderTable();
  });

  // Export modal
  const mask = document.getElementById("mask");
  const btnClose = document.getElementById("btnClose");
  const btnCancel = document.getElementById("btnCancel");
  const btnDoExport = document.getElementById("btnDoExport");
  const selCount = document.getElementById("selCount");
  const tplList = document.getElementById("tplList");

  const templates = [
    { id:"tplA", name:"《旧资料-单机组FRI说明模板》", desc:"用于复核单机组口径、缺失字段、偏离因子说明等" },
    { id:"tplB", name:"《多基地FRI汇总模板》", desc:"用于6基地/24机组的汇总展示与排名" },
    { id:"tplC", name:"《日报模板》", desc:"用于日常通报：异常机组、阈值、处置建议" },
    { id:"tplD", name:"《周报/月报模板》", desc:"用于趋势：预警/告警次数、Top机组、整改闭环" },
  ];

  function openExport(){
    selCount.textContent = selected.size;
    tplList.innerHTML = templates.map((t,idx)=>`
      <div class="check-item">
        <input type="checkbox" id="${t.id}" ${idx<2 ? "checked":""}/>
        <div>
          <div>${t.name}</div>
          <div class="meta">${t.desc}</div>
        </div>
      </div>
    `).join("");
    mask.style.display = "flex";
  }
  function closeExport(){ mask.style.display = "none"; }

  btnExport.addEventListener("click", ()=>{
    if (btnExport.classList.contains("btn-disabled")) return;
    openExport();
  });
  btnClose.addEventListener("click", closeExport);
  btnCancel.addEventListener("click", closeExport);
  mask.addEventListener("click", (e)=>{ if(e.target===mask) closeExport(); });

  btnDoExport.addEventListener("click", ()=>{
    const chosen = templates.filter(t=>document.getElementById(t.id)?.checked).map(t=>t.name);
    if (!chosen.length){
      alert("请至少选择一个导出模板。");
      return;
    }
    closeExport();
    alert("原型提示：已选择模板：\n- " + chosen.join("\n- ") + "\n\n后续可按渠道生成不同文件并分发（多渠道汇报）。");
  });

  // Mock button
  document.getElementById("btnMock").addEventListener("click", ()=>{
    // generate a few completed records
    for(let i=0;i<8;i++){
      const baseKeys = Object.keys(bases);
      const b = baseKeys[Math.floor(Math.random()*baseKeys.length)];
      const u = (1+Math.floor(Math.random()*4)) + "#机组";
      enqueueRecord(Math.random()<0.5 ? "TIMER" : "MANUAL", b, u, 24);
    }
    renderTable();
  });

  // init datetime
  (function initDatetime(){
    const end = new Date();
    const start = new Date(end.getTime() - 24*3600*1000);
    mEnd.value = end.toISOString().slice(0,16);
    mStart.value = start.toISOString().slice(0,16);
  })();

  renderTable();
</script>
</body>
</html>
