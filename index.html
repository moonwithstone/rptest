<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FRI 分析</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#1f2329;
      --sub:#646a73;
      --line:#e6e8ee;
      --blue:#1677ff;
      --blue2:#eaf2ff;
      --grayBtn:#d0d5dd;
      --shadow:0 8px 24px rgba(31,35,41,.08);
      --radius:12px;

      --green:#17c964;
      --yellow:#f5a524;
      --red:#f31260;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Alibaba PuHuiTi 2.0","Alibaba PuHuiTi","Microsoft YaHei",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:var(--bg);
    }
    a{color:inherit;text-decoration:none}
    .app{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* Header (53px) */
    .topbar{
      height:53px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 20px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#ffffff,#fbfcff);
      position:sticky;
      top:0;
      z-index:5;
    }
    .title{min-width:0;
      line-height:1;
    
      font-size:16px;      /* 规范：页面标题16px不加粗 */
      font-weight:400;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .crumb{
      font-size:14px;
      color:var(--sub);
      margin-left:6px;
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:12px;            /* 按钮间距12px */
    }

    /* Buttons */
    .btn{
      height:32px;
      padding:0 12px;
      border-radius:10px;
      border:1px solid transparent;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      font-size:14px;
      background:#fff;
    }
    .btn svg{width:16px;height:16px}
    .btn-primary{
      background:var(--blue);
      border-color:var(--blue);
      color:#fff;
      box-shadow:0 6px 16px rgba(22,119,255,.22);
    }
    .btn-secondary{
      background:#fff;
      border-color:var(--blue);
      color:var(--blue);
    }
    .btn-low{
      background:#fff;
      border-color:var(--grayBtn);
      color:var(--text);
    }
    .btn-disabled{
      opacity:.4;          /* 规范：需要选中才能操作的按钮默认置灰40% */
      cursor:not-allowed;
      pointer-events:none;
    }

    /* Layout */
    .main{
      padding:16px 20px 20px;
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:16px;
    }
    @media (max-width: 1100px){
      .main{grid-template-columns:1fr}
    }

    /* Left Tabs (list page left tabs + right actions) */
    .panel{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(230,232,238,.8);
      overflow:hidden;
    }
    .panel-hd{
      padding:12px 12px 8px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panel-hd .hd-title{
      font-size:14px;      /* 小标题14px + medium(加粗一点) */
      font-weight:600;
    }
    .seg{
      display:flex;
      border:1px solid var(--line);
      border-radius:10px;
      overflow:hidden;
      height:32px;         /* Tab高度32px */
    }
    .seg button{
      border:0;
      background:#fff;
      padding:0 10px;
      font-size:14px;
      cursor:pointer;
      color:var(--sub);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .seg button.active{
      color:var(--blue);
      background:var(--blue2);
      font-weight:600;
    }
    .seg svg{width:16px;height:16px}

    .left-body{
      padding:12px;
    }
    .field{
      margin-bottom:12px;
    }
    .label{
      font-size:14px;
      color:var(--sub);
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .select, .input{
      width:100%;
      height:36px;
      border:1px solid var(--line);
      border-radius:10px;
      padding:0 10px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .hint{
      font-size:12px;
      color:var(--sub);
      line-height:1.5;
      padding:10px;
      background:linear-gradient(180deg,#eaf0ff,#ffffff);
      border:1px solid var(--line);
      border-radius:12px;
    }
    .legend{
      display:grid;
      gap:8px;
      margin-top:12px;
    }
    .pill{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:14px;
      background:#fff;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;margin-right:8px;display:inline-block;
    }
    .pill .left{
      display:flex;align-items:center;color:var(--text);
    }
    .pill .right{
      color:var(--sub);
      font-size:12px;
    }

    /* Right Content */
    .content{
      display:grid;
      grid-template-rows:auto auto 1fr;
      gap:16px;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 1200px){
      .kpi-grid{grid-template-columns: repeat(2, 1fr)}
    }
    .kpi{
      padding:12px;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(230,232,238,.8);
    }
    .kpi .k-title{
      font-size:14px;
      color:var(--sub);
      margin-bottom:8px;
      display:flex;align-items:center;gap:8px;
    }
    .kpi .k-val{
      font-size:22px;
      font-weight:700;
      letter-spacing:.3px;
    }
    .kpi .k-sub{
      margin-top:6px;
      font-size:12px;
      color:var(--sub);
    }

    .grid{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(230,232,238,.8);
      overflow:hidden;
    }
    .grid-hd{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .grid-hd .hd-title{
      font-size:14px;
      font-weight:600;
      display:flex;align-items:center;gap:10px;
    }
    .grid-hd .hd-meta{
      font-size:12px;color:var(--sub);
    }

    .base-cards{
      padding:12px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    @media (max-width: 1200px){
      .base-cards{grid-template-columns: repeat(2, 1fr)}
    }
    @media (max-width: 900px){
      .base-cards{grid-template-columns: 1fr}
    }
    .base-card{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:linear-gradient(180deg,#ffffff,#fbfcff);
      cursor:pointer;
      transition:transform .08s ease, box-shadow .08s ease;
    }
    .base-card:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 24px rgba(31,35,41,.10);
    }
    .base-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .base-name{
      font-size:14px;
      font-weight:600;
    }
    .badge{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--sub);
      background:#fff;
      white-space:nowrap;
    }
    .units{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:8px;
    }
    .unit{
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fff;
    }
    .u-left{
      display:flex;align-items:center;gap:8px;min-width:0;
    }
    .u-name{
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:150px;
    }
    .u-val{
      font-size:14px;
      font-variant-numeric:tabular-nums;
      font-weight:700;
    }

    /* Modal (弹窗：标题16px medium；底色渐变#EAF0FF-#FFFFFF) */
    .mask{
      position:fixed;inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(920px, 100%);
      max-height:min(800px, 90vh);
      overflow:auto;
      border-radius:16px;
      background:linear-gradient(180deg,#EAF0FF,#FFFFFF);
      border:1px solid rgba(230,232,238,.9);
      box-shadow:0 18px 50px rgba(31,35,41,.22);
    }
    .modal-hd{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .modal-title{
      font-size:16px;
      font-weight:600; /* 弹窗标题16px medium */
      display:flex;align-items:center;gap:10px;
    }
    .modal-bd{
      padding:16px;
    }
    .modal-ft{
      padding:14px 16px;
      border-top:1px solid var(--line);
      display:flex;justify-content:flex-end;gap:12px;
      position:sticky;bottom:0;background:rgba(255,255,255,.75);backdrop-filter: blur(8px);
    }

    /* Table (无竖线：单业务表头简约) */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:14px;
    }
    thead th{
      text-align:left;
      color:var(--sub);
      font-weight:600;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      background:#fff;
      position:sticky;top:0;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      background:#fff;
      vertical-align:middle;
    }
    tbody tr:hover td{background:#fbfcff}
    .align-center{text-align:center}
    .align-right{text-align:right}
    .ellipsis{
      max-width:240px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .empty{
      padding:36px 12px;
      text-align:center;
      color:var(--sub);
      font-size:14px;
    }

    /* Loading */
    .loading{
      display:flex;align-items:center;gap:10px;
      color:var(--sub);
      font-size:14px;
      padding:12px;
    }
    .spinner{
      width:18px;height:18px;border-radius:999px;
      border:2px solid rgba(22,119,255,.22);
      border-top-color:var(--blue);
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  
    .title-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px;display:inline-block;}
    .subheader{
      padding:12px 20px 0;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .sub-left{min-width:0}
    .sub-title{font-size:14px;font-weight:600;color:var(--text);line-height:20px;}
    .sub-desc{font-size:12px;color:var(--sub);line-height:18px;margin-top:4px;max-width:920px;}
    .sub-breadcrumb{font-size:12px;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px;}
    @media (max-width: 900px){
      .title-text{max-width:260px}
      .subheader{flex-direction:column;align-items:flex-start}
      .sub-breadcrumb{max-width:100%}
    }
    
  </style>
</head>
<body>
<div class="app">

  <div class="topbar">
    <div class="title">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 19V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v14" stroke="#1677ff" stroke-width="2" stroke-linecap="round"/>
        <path d="M8 7h8M8 11h8M8 15h6" stroke="#1677ff" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class=\"title-text\">FRI 分析</span>
    </div>

    <div class="top-actions">
      <a class="btn btn-secondary" href="fri_calc.html" title="跳转到FRI计算工具页面">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 3v6m0 6v6M3 12h6m6 0h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        FRI计算工具
      </a>
      <button class="btn btn-low" id="btnRefresh">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M20 12a8 8 0 1 1-2.34-5.66" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M20 4v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        刷新数据
      </button>
    </div>
  </div>
  <div class="subheader">
    <div class="sub-left">
      <div class="sub-breadcrumb">风险指标 / FRI / 分析（子页面）</div>
      <div class="sub-title">6个基地 · 24个机组 · 预警/告警限值确认</div>
      <div class="sub-desc">告警限值：绿（指标值 ≤ 0.037）；黄（0.45 ＞ 指标值 ＞ 0.037）；红（指标值 ≥ 0.45）。支持总体显示与单独显示。</div>
    </div>
  </div>


  <div class="main">
    <!-- Left -->
    <div class="panel">
      <div class="panel-hd">
        <div class="hd-title">显示模式</div>
        <div class="seg" role="tablist" aria-label="显示模式">
          <button id="modeOverall" class="active" role="tab">
            <svg viewBox="0 0 24 24" fill="none"><path d="M4 5h16v6H4zM4 13h7v6H4zM13 13h7v6h-7z" stroke="currentColor" stroke-width="2"/></svg>
            总体
          </button>
          <button id="modeSingle" role="tab">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Z" stroke="currentColor" stroke-width="2"/><path d="M4 21a8 8 0 0 1 16 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            单独
          </button>
        </div>
      </div>

      <div class="left-body">
        <div class="field">
          <div class="label">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 6h16M7 12h10M10 18h4" stroke="#646a73" stroke-width="2" stroke-linecap="round"/></svg>
            基地
          </div>
          <select id="selBase" class="select"></select>
        </div>

        <div class="field">
          <div class="label">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 7h12M6 12h12M6 17h12" stroke="#646a73" stroke-width="2" stroke-linecap="round"/></svg>
            机组
          </div>
          <select id="selUnit" class="select"></select>
        </div>

        <div class="hint">
          <div style="font-weight:600;margin-bottom:6px;">告警限值（FRI）</div>
          <div>绿：指标值 ≤ 0.037</div>
          <div>黄：0.45 ＞ 指标值 ＞ 0.037</div>
          <div>红：指标值 ≥ 0.45</div>
        </div>

        <div class="legend">
          <div class="pill">
            <div class="left"><span class="dot" style="background:var(--green)"></span>正常</div>
            <div class="right">≤ 0.037</div>
          </div>
          <div class="pill">
            <div class="left"><span class="dot" style="background:var(--yellow)"></span>预警</div>
            <div class="right">(0.037, 0.45)</div>
          </div>
          <div class="pill">
            <div class="left"><span class="dot" style="background:var(--red)"></span>告警</div>
            <div class="right">≥ 0.45</div>
          </div>
        </div>

      </div>
    </div>

    <!-- Right -->
    <div class="content">

      <div class="kpi-grid" id="kpiGrid">
        <!-- filled by JS -->
      </div>

      <div class="grid">
        <div class="grid-hd">
          <div class="hd-title">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 19V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v14" stroke="#1677ff" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 9h10M7 13h6" stroke="#1677ff" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span id="gridTitle">总体概览（按基地）</span>
          </div>
          <div class="hd-meta" id="gridMeta">默认展示6个基地 · 每基地4个机组（共24）</div>
        </div>

        <div id="gridBody">
          <div class="loading"><div class="spinner"></div>正在加载模拟数据…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="mask" id="mask">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
      <div class="modal-hd">
        <div class="modal-title" id="mTitle">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 3l9 6-9 6-9-6 9-6Z" stroke="#1677ff" stroke-width="2"/>
            <path d="M3 9v6l9 6 9-6V9" stroke="#1677ff" stroke-width="2"/>
          </svg>
          基地详情
        </div>
        <button class="btn btn-low" id="btnClose">
          <svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6l-12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          关闭
        </button>
      </div>
      <div class="modal-bd">
        <div id="detailSummary" style="margin-bottom:12px;color:var(--sub);font-size:14px;"></div>
        <div style="border:1px solid var(--line);border-radius:14px;overflow:hidden;">
          <table>
            <thead>
              <tr>
                <th style="width:120px;">基地</th>
                <th style="width:120px;">机组</th>
                <th class="align-right" style="width:140px;">当前FRI</th>
                <th style="width:120px;">状态</th>
                <th>说明</th>
              </tr>
            </thead>
            <tbody id="detailTbody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-ft">
        <button class="btn btn-low" id="btnModalCancel">取消</button>
        <button class="btn btn-primary" id="btnModalOk">确认</button>
      </div>
    </div>
  </div>

</div>

<script>
  // ====== Mock data (6 bases, 24 units) ======
  const TH_GREEN = 0.037;
  const TH_RED = 0.45;

  const bases = [
    { id: "B1", name: "基地-01（东区）", units: ["1#机组","2#机组","3#机组","4#机组"] },
    { id: "B2", name: "基地-02（西区）", units: ["1#机组","2#机组","3#机组","4#机组"] },
    { id: "B3", name: "基地-03（南区）", units: ["1#机组","2#机组","3#机组","4#机组"] },
    { id: "B4", name: "基地-04（北区）", units: ["1#机组","2#机组","3#机组","4#机组"] },
    { id: "B5", name: "基地-05（海岛）", units: ["1#机组","2#机组","3#机组","4#机组"] },
    { id: "B6", name: "基地-06（内陆）", units: ["1#机组","2#机组","3#机组","4#机组"] },
  ];

  // runtime state
  let mode = "overall"; // overall | single
  let data = []; // rows: {baseId, baseName, unitName, fri, note, ts}

  function randFri(){
    // make distribution: mostly green, some yellow, few red
    const r = Math.random();
    if (r < 0.78) return +(Math.random() * 0.035).toFixed(4);
    if (r < 0.94) return +(0.038 + Math.random() * 0.38).toFixed(4);
    return +(0.45 + Math.random() * 0.2).toFixed(4);
  }

  function statusOf(fri){
    if (fri <= TH_GREEN) return { key:"green", text:"正常", color:"var(--green)" };
    if (fri >= TH_RED) return { key:"red", text:"告警", color:"var(--red)" };
    return { key:"yellow", text:"预警", color:"var(--yellow)" };
  }

  function genData(){
    const now = new Date();
    data = [];
    bases.forEach(b=>{
      b.units.forEach(u=>{
        const fri = randFri();
        const st = statusOf(fri);
        data.push({
          baseId: b.id,
          baseName: b.name,
          unitName: u,
          fri,
          status: st,
          note: st.key==="green" ? "指标处于正常范围" : st.key==="yellow" ? "达到预警区间，建议复核输入数据完整性" : "达到告警区间，建议立即核查并上报",
          ts: now.toISOString()
        });
      });
    });
  }

  function fillBaseSelect(){
    const selBase = document.getElementById("selBase");
    selBase.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "ALL";
    optAll.textContent = "全部基地（总体）";
    selBase.appendChild(optAll);
    bases.forEach(b=>{
      const opt = document.createElement("option");
      opt.value = b.id;
      opt.textContent = b.name;
      selBase.appendChild(opt);
    });
  }

  function fillUnitSelect(baseId){
    const selUnit = document.getElementById("selUnit");
    selUnit.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "ALL";
    optAll.textContent = "全部机组";
    selUnit.appendChild(optAll);

    const base = bases.find(x=>x.id===baseId) || bases[0];
    base.units.forEach(u=>{
      const opt = document.createElement("option");
      opt.value = u;
      opt.textContent = u;
      selUnit.appendChild(opt);
    });
  }

  function kpis(filtered){
    const total = filtered.length;
    const green = filtered.filter(x=>x.status.key==="green").length;
    const yellow = filtered.filter(x=>x.status.key==="yellow").length;
    const red = filtered.filter(x=>x.status.key==="red").length;
    const avg = total ? (filtered.reduce((s,x)=>s+x.fri,0)/total) : 0;
    const max = total ? Math.max(...filtered.map(x=>x.fri)) : 0;

    return { total, green, yellow, red, avg:+avg.toFixed(4), max:+max.toFixed(4) };
  }

  function renderKpis(filtered){
    const { total, green, yellow, red, avg, max } = kpis(filtered);
    const el = document.getElementById("kpiGrid");
    el.innerHTML = `
      <div class="kpi">
        <div class="k-title">
          <span class="dot" style="background:var(--blue)"></span>监控机组数
        </div>
        <div class="k-val">${total}</div>
        <div class="k-sub">6个基地 · 24个机组（可总体/单独显示）</div>
      </div>
      <div class="kpi">
        <div class="k-title"><span class="dot" style="background:var(--green)"></span>正常（绿）</div>
        <div class="k-val">${green}</div>
        <div class="k-sub">≤ ${TH_GREEN}</div>
      </div>
      <div class="kpi">
        <div class="k-title"><span class="dot" style="background:var(--yellow)"></span>预警（黄）</div>
        <div class="k-val">${yellow}</div>
        <div class="k-sub">( ${TH_GREEN} , ${TH_RED} )</div>
      </div>
      <div class="kpi">
        <div class="k-title"><span class="dot" style="background:var(--red)"></span>告警（红）</div>
        <div class="k-val">${red}</div>
        <div class="k-sub">≥ ${TH_RED}</div>
      </div>
      <div class="kpi">
        <div class="k-title">平均FRI</div>
        <div class="k-val">${avg}</div>
        <div class="k-sub">用于趋势参考（模拟）</div>
      </div>
      <div class="kpi">
        <div class="k-title">最大FRI</div>
        <div class="k-val">${max}</div>
        <div class="k-sub">建议优先关注</div>
      </div>
      <div class="kpi">
        <div class="k-title">预警/告警占比</div>
        <div class="k-val">${total ? Math.round(((yellow+red)/total)*100) : 0}%</div>
        <div class="k-sub">（黄+红）/总数</div>
      </div>
      <div class="kpi">
        <div class="k-title">数据更新时间</div>
        <div class="k-val" style="font-size:16px;font-weight:700;">${new Date().toLocaleString()}</div>
        <div class="k-sub">点击右上角“刷新数据”重新生成</div>
      </div>
    `;
  }

  function renderOverall(){
    const body = document.getElementById("gridBody");
    const title = document.getElementById("gridTitle");
    const meta = document.getElementById("gridMeta");

    title.textContent = "总体概览（按基地）";
    meta.textContent = "默认展示6个基地 · 每基地4个机组（共24）";

    const cards = bases.map(b=>{
      const rows = data.filter(x=>x.baseId===b.id);
      const k = kpis(rows);
      const badge = `绿${k.green} / 黄${k.yellow} / 红${k.red}`;
      const unitHtml = rows.map(r=>`
        <div class="unit" title="${b.name} - ${r.unitName}">
          <div class="u-left">
            <span class="dot" style="background:${r.status.color}"></span>
            <div class="u-name">${r.unitName}</div>
          </div>
          <div class="u-val">${r.fri}</div>
        </div>
      `).join("");
      return `
        <div class="base-card" data-base="${b.id}">
          <div class="base-top">
            <div>
              <div class="base-name">${b.name}</div>
              <div style="margin-top:6px;color:var(--sub);font-size:12px;">平均FRI：${k.avg} · 最大FRI：${k.max}</div>
            </div>
            <div class="badge">${badge}</div>
          </div>
          <div class="units">${unitHtml}</div>
        </div>
      `;
    }).join("");

    body.innerHTML = `<div class="base-cards">${cards}</div>`;

    body.querySelectorAll(".base-card").forEach(card=>{
      card.addEventListener("click", ()=>{
        const baseId = card.getAttribute("data-base");
        openDetail(baseId);
      });
    });
  }

  function renderSingle(baseId, unitName){
    const body = document.getElementById("gridBody");
    const title = document.getElementById("gridTitle");
    const meta = document.getElementById("gridMeta");

    title.textContent = "单独显示（按基地/机组）";
    meta.textContent = "选择左侧基地与机组后，展示对应监控结果";

    const filtered = data.filter(x=>{
      if (baseId==="ALL") return true;
      if (x.baseId!==baseId) return false;
      if (unitName==="ALL") return true;
      return x.unitName===unitName;
    });

    if (!filtered.length){
      body.innerHTML = `<div class="empty">暂无数据</div>`;
      return;
    }

    // 15条默认展示：这里取最近15条（模拟只有24条，所以最多24）
    const rows = filtered.slice(0, 15);

    const tbody = rows.map(r=>`
      <tr>
        <td class="ellipsis" title="${r.baseName}">${r.baseName}</td>
        <td class="align-center">${r.unitName}</td>
        <td class="align-right"><span style="font-weight:700">${r.fri}</span></td>
        <td class="align-center">
          <span class="badge" style="border-color:rgba(0,0,0,.08)">
            <span class="dot" style="background:${r.status.color};vertical-align:middle"></span>
            ${r.status.text}
          </span>
        </td>
        <td class="ellipsis" title="${r.note}">${r.note}</td>
        <td class="align-center"><button class="btn btn-secondary" style="height:28px" data-base="${r.baseId}">查看</button></td>
      </tr>
    `).join("");

    body.innerHTML = `
      <div style="padding:12px;">
        <div style="border:1px solid var(--line);border-radius:14px;overflow:hidden;">
          <table>
            <thead>
              <tr>
                <th>基地</th>
                <th class="align-center" style="width:120px;">机组</th>
                <th class="align-right" style="width:140px;">当前FRI</th>
                <th class="align-center" style="width:120px;">状态</th>
                <th>说明</th>
                <th class="align-center" style="width:110px;">操作</th>
              </tr>
            </thead>
            <tbody>${tbody}</tbody>
          </table>
        </div>
        <div style="margin-top:10px;color:var(--sub);font-size:12px;">
          注：此页面为原型预览（模拟数据）。实际项目可接入实时计算结果、阈值配置与历史趋势图。
        </div>
      </div>
    `;

    body.querySelectorAll("button[data-base]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        openDetail(btn.getAttribute("data-base"));
      });
    });
  }

  // ===== Modal detail =====
  const mask = document.getElementById("mask");
  const detailTbody = document.getElementById("detailTbody");
  const detailSummary = document.getElementById("detailSummary");

  function openDetail(baseId){
    const rows = data.filter(x=>x.baseId===baseId);
    const base = bases.find(x=>x.id===baseId);

    const k = kpis(rows);
    detailSummary.textContent = `${base.name}：共${k.total}个机组（绿${k.green} / 黄${k.yellow} / 红${k.red}），平均FRI ${k.avg}，最大FRI ${k.max}。`;

    detailTbody.innerHTML = rows.map(r=>`
      <tr>
        <td class="ellipsis" title="${r.baseName}">${r.baseName}</td>
        <td class="align-center">${r.unitName}</td>
        <td class="align-right"><span style="font-weight:700">${r.fri}</span></td>
        <td class="align-center">
          <span class="badge">
            <span class="dot" style="background:${r.status.color}"></span>${r.status.text}
          </span>
        </td>
        <td class="ellipsis" title="${r.note}">${r.note}</td>
      </tr>
    `).join("");

    mask.style.display = "flex";
  }

  function closeDetail(){ mask.style.display = "none"; }

  document.getElementById("btnClose").addEventListener("click", closeDetail);
  document.getElementById("btnModalCancel").addEventListener("click", closeDetail);
  document.getElementById("btnModalOk").addEventListener("click", closeDetail);
  mask.addEventListener("click", (e)=>{ if(e.target===mask) closeDetail(); });

  // ===== Mode switch =====
  const modeOverall = document.getElementById("modeOverall");
  const modeSingle = document.getElementById("modeSingle");

  function setMode(m){
    mode = m;
    modeOverall.classList.toggle("active", m==="overall");
    modeSingle.classList.toggle("active", m==="single");

    const selBase = document.getElementById("selBase");
    const selUnit = document.getElementById("selUnit");

    if (m==="overall"){
      selBase.value = "ALL";
      fillUnitSelect(bases[0].id);
      selUnit.value = "ALL";
      renderKpis(data);
      renderOverall();
    }else{
      const baseId = selBase.value === "ALL" ? bases[0].id : selBase.value;
      fillUnitSelect(baseId);
      selUnit.value = "ALL";
      const filtered = data.filter(x=>x.baseId===baseId);
      renderKpis(filtered);
      renderSingle(baseId, "ALL");
    }
  }

  modeOverall.addEventListener("click", ()=>setMode("overall"));
  modeSingle.addEventListener("click", ()=>{
    const selBase = document.getElementById("selBase");
    if (selBase.value==="ALL") selBase.value = bases[0].id;
    setMode("single");
  });

  // ===== Select listeners =====
  document.getElementById("selBase").addEventListener("change", (e)=>{
    const baseId = e.target.value;
    if (mode==="overall"){
      // overall ignores base filter, keep ALL
      e.target.value = "ALL";
      return;
    }
    fillUnitSelect(baseId);
    document.getElementById("selUnit").value = "ALL";
    const filtered = data.filter(x=>x.baseId===baseId);
    renderKpis(filtered);
    renderSingle(baseId, "ALL");
  });

  document.getElementById("selUnit").addEventListener("change", (e)=>{
    if (mode!=="single") return;
    const baseId = document.getElementById("selBase").value;
    const unitName = e.target.value;
    const filtered = data.filter(x=>x.baseId===baseId && (unitName==="ALL" ? true : x.unitName===unitName));
    renderKpis(filtered);
    renderSingle(baseId, unitName);
  });

  // Refresh
  document.getElementById("btnRefresh").addEventListener("click", ()=>{
    genData();
    // keep mode
    if (mode==="overall"){
      renderKpis(data);
      renderOverall();
    }else{
      const baseId = document.getElementById("selBase").value;
      const unitName = document.getElementById("selUnit").value;
      const filtered = data.filter(x=>x.baseId===baseId && (unitName==="ALL" ? true : x.unitName===unitName));
      renderKpis(filtered);
      renderSingle(baseId, unitName);
    }
  });

  // Init
  fillBaseSelect();
  fillUnitSelect(bases[0].id);
  genData();
  setTimeout(()=>{
    renderKpis(data);
    renderOverall();
  }, 250);
</script>
</body>
</html>
